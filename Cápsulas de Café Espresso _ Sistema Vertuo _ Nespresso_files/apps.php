(function(){(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerpolicy&&(r.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?r.credentials="include":s.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();class nt{constructor(t,e,i,s,r,a,o,c,l=window){this._config=t,this._webLoadder=null,this._communicator=e,this._storage=i,this._triggerManager=s,this._activations=r,this._translator=a,this._dispatcher=o,this._datalayer=c,this._window=l,this._lastActivation=null,this._pageUnloaded=!1,this._timeoutSaveStorage=null}start(){this._communicator.loadCss(),this._processApiLoader()}saveStorage(){!this._storage||this._storage.sleep()}saveStorageDelayed(){this._timeoutSaveStorage&&(this._window.clearTimeout(this._timeoutSaveStorage),this._timeoutSaveStorage=null),this._pageUnloaded?this.saveStorage():this._timeoutSaveStorage=this._window.setTimeout(()=>this.saveStorage(),100)}_unload(){this._pageUnloaded=!0,this.saveStorage()}_processApiLoader(){if(this._window._calleoTrigger){const t=this._window._calleoTrigger;t.app=this,t.market=String(t.market).toLowerCase(),t.language=String(t.language).toLowerCase(),t.channel=String(t.channel).toLowerCase(),t.queue.unshift(["customer.market",t.market]),t.queue.unshift(["customer.language",t.language]),t.queue.unshift(["customer.channel",t.channel]),this._communicator.setContextParams(t.market,t.language,t.channel),this._datalayer.init(t.market,t.language,t.channel),this._webLoadder=t,this._loadRules()}else this._window.setTimeout(()=>this._processApiLoader(),200)}_loadRules(){this._communicator.retrieveRules(t=>{this._config.apiSettings=t.settings,this._config.market_id=t.market_id;const e=this._storage.getStorage("navigation");e&&e.setLifeTime(t.settings.browsing_lifetime),this._translator.pushTranslations(t.translations),this._translator.pushList(t.list),this._datalayer.load(),this._storage.wakeUp(`virtua_live_trigger_${t.market_id}`);const i=this._storage.getStorage("customer"),s=i.getValue("UserLoginTime");if(this._datalayer.isLoggedIn&&!s?i.callValue("UserLoginTime",new Date().getTime()):!this._datalayer.isLoggedIn&&s&&i.callValue("UserLoginTime",null),this._processApiBinding(),this._window.addEventListener("beforeunload",()=>this._unload()),this._window.addEventListener("unload",()=>{this._pageUnloaded||this._unload()}),this._dispatcher.on("store.updated",()=>this.saveStorageDelayed()),!this._config.apiSettings.enabled)return this._dispatcher.emit("settings.not-enabled"),!1;this._config.apiSettings.is_chat_open||this._dispatcher.emit("settings.chat_is_not_open"),this._config.apiSettings.moderator_in_room||this._dispatcher.emit("settings.absent-moderator-in-room");const r=100-Math.round(Math.random()*100),a=i.getValue("customerPercent")||r;if(i.callValue("customerPercent",a),this._config.apiSettings.customer_percent<a)return this._dispatcher.emit("settings.customer-percent",a,this._config.apiSettings.customer_percent),!1;this._triggerManager.populate(t.triggers),this._dispatcher.emit("trigger.processing",t.triggers),this._registerHtml5PushState(),this._registerAnchorChange(),this._registerCartUpdate(),this._processTriggerActivation()}),this._window.calleoChat&&(this._window.calleoChat("addChatListener","launch",()=>{this._storage.getStorage("customer").callValue("isChatBusy",!0).callValue("lastChatStart",new Date().getTime());const t=this._storage.getStorage("trigger");t.getTrigger()&&t.setTrigger(null),this._cleanUpCurrentActivation(),this._dispatcher.emit("trigger.livechat-launch")}),this._window.calleoChat("addChatListener","display-status",t=>{this._storage.getStorage("customer").callValue("isChatExpanded",Boolean(t)),t&&this._cleanUpCurrentActivation()&&this._dispatcher.emit("trigger.livechat-expand.ignore")}),this._window.calleoChat("addChatListener","end",()=>{this._storage.getStorage("customer").callValue("isChatBusy",!1).callValue("lastChatEnd",new Date().getTime())}),this._window.calleoChat("addChatListener","cancel",()=>{this._storage.getStorage("customer").callValue("isChatBusy",!1).callValue("lastChatEnd",new Date().getTime())}))}_cleanUpCurrentActivation(){return this._lastActivation?(this._lastActivation.clear(),this._lastActivation.hidePopup(),this._lastActivation=null,!0):!1}_processTriggerActivation(){let t=!0;const e=this._storage.getStorage("trigger"),i=e.getTrigger();this._dispatcher.emit("store.updated");const s=this._config.apiSettings.expiration_delay*60,r=this._storage.getStorage("customer").getValue("lastChatEnd");if(this._storage.getStorage("customer").getValue("isChatBusy")===!0){this._dispatcher.emit("trigger.livechat-busy"),e.setTrigger(null);return}else if(this._storage.getStorage("customer").getValue("isChatExpanded")===!0){this._dispatcher.emit("trigger.livechat-expand");return}else if(r&&r+s*1e3>new Date().getTime()){this._dispatcher.emit("trigger.livechat-not-showable",r,s);return}i&&(i.isShowable(this._config.apiSettings.invitation_reaction_time)?(this._activate(i),t=!1,i.isLaunched()&&this._dispatcher.emit("trigger.is-showable",i,this._config.apiSettings.invitation_reaction_time)):i.isExpired(s)?(e.setTrigger(null),this._dispatcher.emit("trigger.is-expired",this._config.apiSettings.expiration_delay)):i.isExpired(s)||(t=!1,i.isShowable(this._config.apiSettings.invitation_reaction_time+20)&&this._activations[i.activationType].handleIgnore(i),this._dispatcher.emit("trigger.is-not-showable",i,s))),t&&this._processTriggers(),this._dispatcher.emit("store.updated")}_processTriggers(){const t=this._triggerManager.match();t===null?this._dispatcher.emit("trigger.match-none"):(this._dispatcher.emit("trigger.matched",t),this._activate(t))}_processApiBinding(){this._webLoadder&&(this._webLoadder.callMethod=(...t)=>this.apiCallMethod(...t),this._webLoadder.queue.forEach(t=>this.apiCallMethod(...t)),this._webLoadder.queue=[])}_registerAnchorChange(){"onhashchange"in this._window&&this._window.addEventListener("hashchange",()=>{this._window.setTimeout(()=>{this._dispatcher.emit("history.hashchange",this._window.location.hash)},0)},!1),this._dispatcher.on("history.hashchange",()=>{this._processJavascriptNavigation()})}_registerHtml5PushState(){const t=this._window.history;if(t&&typeof t.pushState=="function"){const e=t.pushState;t.pushState=(...i)=>{try{this._window.setTimeout(()=>{this._dispatcher.emit("history.pushState",...i)},0)}catch(s){}return e.apply(t,i)}}this._dispatcher.on("history.pushState",()=>{this._processJavascriptNavigation()})}_registerCartUpdate(){let t=!1;try{window.napi&&(window.napi.data().on("cart.*",e=>{e==="cart.update"&&this._window.setTimeout(()=>{this._dispatcher.emit("cart.updated")},0)}),t=!0)}catch(e){console.warn(`cannot register cart update by api ${e}`)}if(!t)try{this._window.jQuery&&this._window.jQuery(document).on("cartUpdated",()=>{this._window.setTimeout(()=>{this._dispatcher.emit("cart.updated")},0)})}catch(e){console.warn(`cannot register cart update by jquery ${e}`)}this._dispatcher.on("cart.updated",()=>{this._processCartUpdate()})}_processJavascriptNavigation(){this._storage.sleep();for(const t in this._activations)Object.prototype.hasOwnProperty.call(this._activations,t)&&this._activations[t].clear();this._storage.wakeUp(`virtua_live_trigger_${this._config.market_id}`),this._processTriggerActivation()}_processCartUpdate(){this._datalayer.load(),this._processTriggerActivation()}_activate(t){const e=t.activationType;t.isActivated()?this._activations[e].handle(t,!1):e in this._activations&&(t.activate(),this._activations[e].launch(t)),this._lastActivation=this._activations[e]}apiCallMethod(t,...e){t=String(t),t&&(typeof this[t]=="function"?this[t](...e):this._storage.callValue(t,...e))}addTriggerListener(t,e){this._dispatcher.on(t,e)}}class E{constructor(){this.data={}}sleep(){return this.data}wakeUp(t){this.data=t}callValue(t,...e){return this.data[t]=e[0],this}getValue(t){return typeof this.data[t]!="undefined"?this.data[t]:null}setData(t){this.data=t}}var F={exports:{}};/*!
 * JavaScript Cookie v2.1.4
 * https://github.com/js-cookie/js-cookie
 *
 * Copyright 2006, 2015 Klaus Hartl & Fagner Brack
 * Released under the MIT license
 */(function(n,t){(function(e){var i=!1;if(n.exports=e(),i=!0,!i){var s=window.Cookies,r=window.Cookies=e();r.noConflict=function(){return window.Cookies=s,r}}})(function(){function e(){for(var s=0,r={};s<arguments.length;s++){var a=arguments[s];for(var o in a)r[o]=a[o]}return r}function i(s){function r(a,o,c){var l;if(typeof document!="undefined"){if(arguments.length>1){if(c=e({path:"/"},r.defaults,c),typeof c.expires=="number"){var m=new Date;m.setMilliseconds(m.getMilliseconds()+c.expires*864e5),c.expires=m}c.expires=c.expires?c.expires.toUTCString():"";try{l=JSON.stringify(o),/^[\{\[]/.test(l)&&(o=l)}catch(z){}s.write?o=s.write(o,a):o=encodeURIComponent(String(o)).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),a=encodeURIComponent(String(a)),a=a.replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent),a=a.replace(/[\(\)]/g,escape);var f="";for(var v in c)!c[v]||(f+="; "+v,c[v]!==!0&&(f+="="+c[v]));return document.cookie=a+"="+o+f}a||(l={});for(var S=document.cookie?document.cookie.split("; "):[],C=/(%[0-9A-Z]{2})+/g,L=0;L<S.length;L++){var $=S[L].split("="),g=$.slice(1).join("=");g.charAt(0)==='"'&&(g=g.slice(1,-1));try{var P=$[0].replace(C,decodeURIComponent);if(g=s.read?s.read(g,P):s(g,P)||g.replace(C,decodeURIComponent),this.json)try{g=JSON.parse(g)}catch(z){}if(a===P){l=g;break}a||(l[P]=g)}catch(z){}}return l}}return r.set=r,r.get=function(a){return r.call(r,a)},r.getJSON=function(){return r.apply({json:!0},[].slice.call(arguments))},r.defaults={},r.remove=function(a,o){r(a,"",e(o,{expires:-1}))},r.withConverter=i,r}return i(function(){})})})(F);class at{constructor(t={base:new E},e="base",i,s){this.managers=t,this.config=i,this.dispatcher=s,this.defaultManager=e,this.storagePrefix=null,this.settings={}}getStorage(t){return typeof this.managers[t]!="undefined"?this.managers[t]:null}callValue(t,...e){t=String(t);let i=t;t.indexOf(".")!==-1&&([i,t]=t.split(".",2)),typeof this.managers[i]=="undefined"&&(i=this.defaultManager),this.managers[i].callValue(t,...e)}sleep(){if(!this.canStore())return!1;const t=this._getStorage(),e=this.storagePrefix;let i=null;if(e&&t)for(const s in this.managers)Object.prototype.hasOwnProperty.call(this.managers,s)&&(i=this.managers[s].sleep(),i=t.setItem(`${this.storagePrefix}_${s}`,JSON.stringify(i)))}wakeUp(t){const e=this._getStorage();let i=null;this.storagePrefix=t,this._limitStorage2BrowserSession();for(const s in this.managers)if(Object.prototype.hasOwnProperty.call(this.managers,s)){if(i=e.getItem(`${this.storagePrefix}_${s}`),i)try{i=JSON.parse(i)}catch(r){console.error(`Error on process data storage ${s} from json ${i}`)}else i={};this.managers[s].wakeUp(i)}}cleanUpStorage(t=null){const e=this._getStorage();t&&(this.storagePrefix=t),t=this.storagePrefix,Object.keys(e).forEach(i=>{String(i).startsWith(t)&&localStorage.removeItem(i)})}cleanUpSession(){const t=`${this.storagePrefix}_session_token`;localStorage.removeItem(t)}_limitStorage2BrowserSession(){const t=this._getStorage(),e=`${this.storagePrefix}_session_token`,i="vcrm_trigger",s=t.getItem(e);let r=F.exports.get(i);r||(r=Math.random().toString(36).substring(5),F.exports.set("vcrm_trigger",r)),r!==s&&(this.cleanUpStorage(),t.setItem(e,r))}_getStorage(){return window.localStorage}canStore(){return!0}}class ot extends E{constructor(t,e){super(),this.config=t,this.datalayer=e}getQueryParams(){const t=[],e=this.getValue("Title");e&&t.push(`title=${encodeURIComponent(e)}`);const i=this.getValue("LastName");i&&t.push(`last_name=${encodeURIComponent(i)}`);const s=this.getValue("FirstName");s&&t.push(`first_name=${encodeURIComponent(s)}`);const r=this.getValue("Email");return r&&t.push(`email=${encodeURIComponent(r)}`),t.join("&")}getValue(t){let e=super.getValue(t);const i=t.charAt(0).toLowerCase()+t.slice(1);return e===null&&this.datalayer&&typeof this.datalayer[i]!="undefined"&&(e=this.datalayer[i]),e}callValue(t,...e){return e=this._transformValues(t,e),super.callValue(t,...e)}wakeUp(t){this.data=Object.assign(this.data,t)}_transformValues(t,e){return t==="Title"&&(e[0]=String(e[0]).replace(".","").toLowerCase()),e}}class y{static convertToRelativeUrl(t){return String(t).replace(/^(?:\/\/|[^\/]+)*/,"")||"/"}static _matchURI(t){return String(t).match(/^((https?):\/\/(([^@]*)@|)(([^:\/?#]*)(?::([0-9]+))?)|)(\/[^?#]*)?(\?([^#]*)|)(#(.*)|)$/)||null}static getSchemeDefaultPort(t){switch(t){case"http":return 80;case"https":return 443;default:return""}}static parseURI(t){const e=y._matchURI(t);return e&&{scheme:e[2]||"",userinfo:e[4]||"",host:e[6]||"",port:parseInt(e[7],10)||y.getSchemeDefaultPort(e[2])||"",path:e[8]||(e[6]?"/":""),query:e[10]||"",fragment:e[12]||""}}static parseURIBase(t){const e=y._matchURI(t);return e&&{host:e[6]||"",path:e[8]||(e[6]?"/":""),query:e[10]||"",fragment:e[12]||""}}static concatUrlItem(t){let e=t.path;return e+=t.query?`?${t.query}}`:"",e}}class ct extends E{constructor(t){super(),this.data.urls=[],this.data.currentUrl=null,this.data.totalDuration=0,this.data.totalUserDuration=0,this.lifeTime=3600,this.datalayer=t}setLifeTime(t){this.lifeTime=t*60}wakeUp(t){const e=new Date().getTime()-this.lifeTime*1e3;for(t.urls=t.urls||[],t.currentUrl=t.currentUrl||null,t.totalDuration=t.totalDuration||0,t.totalUserDuration=t.totalDuration||0;t.urls.length>0&&t.urls[0].t<e;)t.urls.shift();super.wakeUp(t),this.addUrl()}sleep(){return this.data.currentUrl&&(this.data.currentUrl.d=Math.floor((new Date().getTime()-this.data.currentUrl.t)/1e3)),super.sleep()}_pushCurrentUrl(){this.data.currentUrl&&(this.data.totalDuration+=this.data.currentUrl.d,this.data.urls.push(this.data.currentUrl)),this.data.currentUrl=null}addUrl(t=window.location.href,e){const i=y.parseURIBase(t);(!e||!(e instanceof Date))&&(e=new Date),this.isNewUrl(t)&&(this._pushCurrentUrl(),this.data.currentUrl={t:e.getTime(),p:i,d:0,ud:0,pid:this.datalayer.pageId})}isNewUrl(t){return!this.data.currentUrl||!this.data.currentUrl.p||!this.data.currentUrl.pid||!this.compareUrl(this.data.currentUrl.p,t)||this.datalayer.pageId!==this.data.currentUrl.pid}getHistory(){return this.data.urls}getFullUrls(){return this.data.urls.concat([this.data.currentUrl])}flushHistory(){this.data.urls=[]}hasUrl(t){return this.compareUrl(this.data.currentUrl.p,t)||typeof this.data.urls.find(e=>this.compareUrl(e.p,t))!="undefined"}compareUrl(t,e){const i=y.parseURIBase(e);return(i.host===""||t.host===i.host)&&(i.path===""||t.path===i.path)&&(i.query===""||t.query!==""&&t.query.indexOf(i.query)!==-1)&&(i.fragment===""||t.fragment===i.fragment)}findUrl(t,e=!1){const i=[];return this.data.urls.concat([this.data.currentUrl]).forEach(r=>this.compareUrl(r.p,t)?i.push(r):null),e?i:i.pop()}findFirstUrl(t){return this.findUrl(t,!0).shift()}findPageId(t,e=!1){const i=[];return this.data.urls.concat([this.data.currentUrl]).forEach(r=>r.pid===t?i.push(r):null),e?i:i.pop()}findFirstPageId(t){return this.findPageId(t,!0).shift()}getLastUrlIndex(t){if(this.compareUrl(this.data.currentUrl.p,t))return this.data.urls.length;const e=[];return this.data.urls.map((i,s)=>this.compareUrl(i.p,t)?e.push(s):null),e.pop()}matchUrl(t,e){return this.data.urls.concat(this.data.currentUrl).some(i=>new RegExp(t,e).exec(y.concatUrlItem(i.p))!==null)}findMatchUrl(t,e){const i=[];return this.data.urls.concat([this.data.currentUrl]).forEach(r=>{new RegExp(t,e).exec(y.concatUrlItem(r.p))!==null&&i.push(r)}),i}isCurrentUrl(t){return this.compareUrl(this.data.currentUrl.p,t)}isCurrentPid(t){return this.data.currentUrl.pid===t}matchCurrentUrl(t,e){return new RegExp(t,e).exec(y.concatUrlItem(this.data.currentUrl.p))!==null}getTimeOnSite(){return this.data.totalDuration}getOnSiteDuration(){return this.data.totalDuration}getCurrentUrlDuration(){return this.data.currentUrl===null?0:this.data.currentUrl.t}getTimeOnCurrentPage(){return new Date().getTime()-this.data.currentUrl.t}getVisitedUrl(){return this.data.urls.length+1}callValue(t,e){switch(t){case"navigation":this.addUrl(e);break}return null}}class lt extends E{constructor(t){super(),this.datalayer=t}getValue(){return this.datalayer.cart.totalAmount}getNbProduct(){return this.datalayer.cart.nbUniqueItem}getProducts(){return this.datalayer.cart.items}hasProductName(t){const e=this.getProducts();return t=String(t).toLowerCase().trim(),e.some(i=>i.names.some(s=>t===s))}}class X{constructor({id:t,name:e,secure:i,category:s,activationType:r,invitationMessage:a=null,criterions:o=[],attribs:c={},activatedAt:l=null,launchedAt:m=null,refusedAt:f=null,acceptedAt:v=null,ignoreAt:S=null,startMode:C=null}){this.id=t,this.name=e,this.category=s,this.secure=i,this.activationType=r,this.criterions=o,this.attribs=c,this.activatedAt=l,this.launchedAt=m,this.refusedAt=f,this.acceptedAt=v,this.ignoreAt=S,this.invitationMessage=a,this.startMode=C}activate(){this.activatedAt=this.activatedAt||new Date().getTime()}launch(){this.launchedAt=this.launchedAt||new Date().getTime()}refuse(){this.refusedAt=this.refusedAt||new Date().getTime()}accept(){this.acceptedAt=this.acceptedAt||new Date().getTime()}ignore(){this.ignoreAt=this.ignoreAt||new Date().getTime()}isLaunched(){return this.launchedAt!==null}isActivated(){return this.activatedAt!==null}isIgnore(){return this.ignoreAt!==null}isExpired(t){const e=new Date().getTime(),i=t*1e3;let s=null;return this.acceptedAt!==null?s=this.acceptedAt+i:this.refusedAt!==null?s=this.refusedAt+i:this.launchedAt!==null&&(s=this.launchedAt+i),s!==null?e>=s:!1}isShowable(t=null){const i=new Date().getTime()-t*1e3;return this.acceptedAt===null&&this.refusedAt===null&&(this.launchedAt===null||this.launchedAt>i)}isAnswered(){return this.acceptedAt!==null||this.refusedAt!==null}reset(){this.acceptedAt=null,this.refusedAt=null,this.launchedAt=null,this.activatedAt=null,this.ignoreAt=null}}class ht extends E{constructor(){super(),this.data.trigger=null,this.data.excluded={}}setTrigger(t){this.data.trigger=t}getTrigger(){return this.getValue("trigger")}wakeUp(t){t.trigger=t.trigger||null,t.excluded=t.excluded||{},t.trigger!==null&&(t.trigger=new X(t.trigger)),super.wakeUp(t)}exclude(t){this.data.excluded[t.id]=t.id}isExcluded(t){return t.id in this.data.excluded}}class ut{constructor(t){this._criterions=t}getCriterion(t){if(t in this._criterions)return this._criterions[t];throw new Error(`Criterion '${t}' not found`)}}class u{match(t){throw new Error(`The method 'match' must be implemented ${t}`)}}class k extends u{constructor(t){super(),this._navigationStorage=t}_arrayClone(t){let e,i;if(Array.isArray(t)){for(i=t.slice(0),e=0;e<i.length;e++)i[e]=this._arrayClone(i[e]);return i}return t}getAttributes(t){return this._arrayClone(t.attributes.url)}matchCompare(t,e){return this._navigationStorage.compareUrl(t.p,e)===!0}match(t){const e=this._navigationStorage,i=this.getAttributes(t),s=t.attributes.exact_order,r=Number(t.attributes.time_since_first_match),a=e.getFullUrls(),o=s?this.matchExactOrder(a,i):this.matchAnyOrder(a,i);let{result:c,firstTime:l}=o;return c===!0&&r>0&&(c=k.compareFirstMatch(r,l)),c}matchExactOrder(t,e){let i=0;return{result:t.some(r=>(this.matchCompare(r,e[0])&&(i===0&&(i=r.t),e.shift()),e.length===0)),firstTime:i}}matchAnyOrder(t,e){let i=0;return{result:t.some(r=>(e.forEach((a,o)=>{this.matchCompare(r,a)&&(i===0&&(i=r.t),e.splice(o,1))}),e.length===0)),firstTime:i}}static compareFirstMatch(t,e){return new Date().getTime()-t*1e3>=e}}class dt extends k{getAttributes(t){return this._arrayClone(t.attributes.page_id)}matchCompare(t,e){return t.pid===e}}class G extends u{constructor(t){super(),this._navigationStorage=t}getAttributes(t){return t.attributes.url}getNavigation(t,e){const i=this._navigationStorage;return e?i.findFirstUrl(t):i.findUrl(t)}match(t){const e=this.getAttributes(t),i=Number(t.attributes.time_since_first_match)||0,s=i>0,r=new Date().getTime();return e.some(a=>{const o=this.getNavigation(a,s);return o&&(i===0||r-i*1e3>=o.t)})}}class gt extends G{getAttributes(t){return t.attributes.page_id}getNavigation(t,e){const i=this._navigationStorage;return e?i.findFirstPageId(t):i.findPageId(t)}}class pt extends u{constructor(t){super(),this._navigationStorage=t}match(t){const e=Number(t.attributes.time_since_first_match),i=this._navigationStorage.findMatchUrl(t.attributes.regexp,t.attributes.options);let s=i.length>0;return e>0&&(s=i.reverse().some(r=>new Date().getTime()-e*1e3>=r.t)),s}}class mt extends u{constructor(t){super(),this._navigationStorage=t}match(t){const e=this._navigationStorage,i=parseInt(t.attributes.nb_visited_pages,10);return e.getVisitedUrl()>=i}}class A extends u{constructor(t,e){super(),this._customerStorage=t,this._segmentName=e}match(t){const e=String(t.attributes.segment).toLowerCase().trim(),i=this._customerStorage.getValue("customerSegment");return i&&i[this._segmentName]?i[this._segmentName]===e:!1}}class ft extends u{constructor(t){super(),this._customerStorage=t}match(t){const e=String(t.attributes.city).toLowerCase().trim();return String(this._customerStorage.getValue("city")).toLowerCase().trim()===e}}class _t extends u{constructor(t){super(),this._customerStorage=t}match(t){const e=String(t.attributes.zip).toLowerCase().trim();return String(this._customerStorage.getValue("zip")).toLowerCase().trim()===e}}class vt extends u{constructor(t){super(),this._customerStorage=t}match(t){let e=Number(this._customerStorage.getValue("UserLoginTime"));if(!e||!this._customerStorage.getValue("IsLoggedIn"))return!1;const i=parseInt(t.attributes.time_logged,10);return e=Math.round((new Date().getTime()-e)/1e3),e>=i}}class wt extends u{constructor(t){super(),this._customerStorage=t}match(t){const e=Boolean(t.attributes.logged);return this._customerStorage.getValue("isLoggedIn")===e}}class R extends u{constructor(t,e,i){super(),this._cartStorage=t,this._productFieldKey=e,this._attributeName=i}_arrayClone(t){let e,i;if(Array.isArray(t)){for(i=t.slice(0),e=0;e<i.length;e++)i[e]=this._arrayClone(i[e]);return i}return t}_getAttributes(t){return this._arrayClone(t.attributes[this._attributeName])}matchCompare(t,e){return e=String(e).toLowerCase().trim(),t[this._productFieldKey].some(i=>i===e)}match(t){const e=this._getAttributes(t),i=this._cartStorage.getProducts();return this.matchAnyOrder(i,e)}matchAnyOrder(t,e){return t.some(i=>{const s=[];return e.forEach((r,a)=>{this.matchCompare(i,r)&&s.push(a)}),s.reverse().forEach(r=>e.splice(r,1)),e.length===0})}}class j extends R{matchAnyOrder(t,e){return e.some(i=>t.find(s=>this.matchCompare(s,i)))}}class yt extends u{constructor(t){super(),this._cartStorage=t}match(t){const e=parseInt(t.attributes.product,10);return this._cartStorage.getNbProduct()>=e}}class bt extends u{constructor(t){super(),this._cartStorage=t}match(t){const e=parseFloat(t.attributes.value);return this._cartStorage.getValue()>=e}}class J extends u{constructor(t){super(),this._navigationStorage=t}getAttributes(t){return t.attributes.url}matchCompare(t){const e=this._navigationStorage;return t.some(i=>e.isCurrentUrl(i))}match(t){const e=this.getAttributes(t);return this.matchCompare(e)}}class St extends J{getAttributes(t){return t.attributes.page_id}matchCompare(t){const e=this._navigationStorage;return t.some(i=>e.isCurrentPid(i))}}class Ct extends u{constructor(t){super(),this.navigationStorage=t}match(t){return this.navigationStorage.matchCurrentUrl(t.attributes.regexp,t.attributes.options)}}class Tt extends u{constructor(t){super(),this.customerStorage=t}match(t){const e=t.attributes.channel;return this.customerStorage.getValue("channel")===e}}class Lt extends u{constructor(t){super(),this.customerStorage=t}match(t){const e=t.attributes.language;return this.customerStorage.getValue("language")===e}}class At extends u{constructor(t){super(),this._navigationStorage=t}match(t){const e=this._navigationStorage,i=parseInt(t.attributes.time,10);return e.getTimeOnCurrentPage()>=i}}class $t extends u{constructor(t){super(),this._navigationStorage=t}match(t){const e=this._navigationStorage,i=parseInt(t.attributes.time,10);return e.getTimeOnSite()>=i}}class xt extends u{constructor(t=window){super(),this._win=t}match(t){const e=this._win.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,i=t.attributes.value.map(r=>parseInt(r,10)),s=Object.keys(t.attributes.items).map(r=>parseInt(r,10)).sort((r,a)=>r-a);s.push(1e9);for(let r=0;r<s.length-1;r++)if(e>=s[r]&&e<s[r+1]&&i.indexOf(s[r])!==-1)return!0;return!1}}class Ut{constructor(t,e,i){this.triggers=[],this.criterionManager=t,this.dispatcher=e,this.triggerStorage=i,e.on("reset.storage",()=>{this.triggers.forEach(s=>s.reset())})}addTrigger(t){this.triggers.push(t)}populate(t){t.forEach(e=>{const i=new X(e);this.addTrigger(i)})}match(){const t=this.triggers,e=this.criterionManager,i=t.length,s=this.triggerStorage;for(let r=0;r<i;r++){const a=t[r],o=a.criterions;let c=!0;if(s.isExcluded(a)){this.dispatcher.emit("trigger.is-excluded",a);continue}for(let l=0;l<o.length;l++){const m=o[l];try{e.getCriterion(m.name).match(m)||(c=!1)}catch(f){c=!1,this.dispatcher.emit("trigger.match-error",f),console.error(f)}}if(!!c)return a}return null}}class It{constructor(t,e){this.baseUrl=t.url.api,this.testMode=0,this.market=null,this.language=null,this.channel=null,this.config=t,this.dispatcher=e,this.isIE9=window.XMLHttpRequest&&window.XDomainRequest&&!("withCredentials"in new XMLHttpRequest)}setContextParams(t,e,i){this.market=t,this.language=e,this.channel=i}setTestMode(t){this.testMode=t?1:0}retrieveRules(t){const e={market:this.market,language:this.language,channel:this.channel},i=`${this.baseUrl}/api/trigger/`;this.testMode&&(e.t=Date.now(),e.testmode=this.testMode),this.dispatcher.emit("trigger.loading",i,e),fetch(i+"?"+new URLSearchParams(e),{method:"GET",mode:"cors",headers:{"Content-Type":"application/json"}}).then(s=>{s.ok?s.json().then(r=>t(r)):s.json().then(r=>{this.dispatcher.emit("trigger.loading.error",r)})}).catch(s=>{this.dispatcher.emit("trigger.loading.error",s)})}serialize(t,e){var i=[],s;for(s in t)if(t.hasOwnProperty(s)){var r=e?e+"["+s+"]":s,a=t[s];i.push(a!==null&&typeof a=="object"?serialize(a,r):encodeURIComponent(r)+"="+encodeURIComponent(a))}return i.join("&")}sendAction(t,e,i,s,r=null){const a=`${this.baseUrl}/api/trigger/${t}/${i}`;r||(r=(c,l)=>{console.error(`Cannot send action ${i} to #${t} ${c} ${l}`)});const o={id:t,market:this.market,language:this.language,channel:this.channel,secure:e};this.testMode&&(o.testmode=this.testMode),this.dispatcher.emit("trigger.send-action",i),fetch(a+"?"+new URLSearchParams(o),{method:"POST",mode:"cors",body:JSON.stringify(o),credentials:"include",headers:{"Content-Type":"application/json"}}).then(c=>{c.ok?c.json().then(l=>s(l)):(r(),c.json().then(l=>{this.dispatcher.emit("trigger.send-action.error",l)}))}).catch(c=>{r(),this.dispatcher.emit("trigger.send-action.error",c)})}loadCss(){{const t=document.createElement("link");t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href",`${this.baseUrl}/apps.php?a=calleo-triggers.css`),document.body.appendChild(t)}}getUriLivechat(){const t=[];return t.push(this.config.url.livechat),t.push(this.market),t.push(this.language),t.push(this.config.livechatController),t.join("/")}}class p{static addClass(t,e){t.classList?t.classList.add(e):t.className+=` ${e}`}static removeClass(t,e){t.classList?t.classList.remove(e):t.className=t.className.replace(new RegExp(`(^|\\b)${e.split(" ").join("|")}(\\b|$)`,"gi")," ")}static create(t){const e=document.createDocumentFragment(),i=document.createElement("div");for(i.innerHTML=t;i.firstChild;)e.appendChild(i.firstChild);return e}static htmlEscape(t){return t.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/`/g,"&#96;")}static nl2br(t){return String(t).replace(/(\r\n|\n\r|\r|\n)/g,"<br/>")}static popupBottomRight(t,e,i,s,r={}){const a=window.screen;let o=(a.availWidth||a.width)-i,c=(a.availHeight||a.height)-s;const l=window.navigator.appVersion;l&&l.indexOf("Windows")!==-1&&l.indexOf("Chrome")!==-1&&l.indexOf("Edge")===-1&&l.indexOf("MSIE")===-1&&(c-=50,o-=4);let{toolbar:m,location:f,directories:v,status:S,menubar:C,scrollbars:L,resizable:$,copyhistory:g}=r;return m=m||"no",f=f||"no",v=v||"no",S=S||"no",C=C||"no",L=L||"no",$=$||"no",g=g||"no",window.open(t,e,`toolbar=${m}, location=${f}, directories=${v}, status=${S}, menubar=${C}, scrollbars=${L}, resizable=${$}, copyhistory=${g}, width=${i}, height=${s}, top=${c}, left=${o}`)}}class D{constructor(t,e,i,s,r,a){this.config=t,this.triggerStorage=e,this.customerStorage=i,this.popup=s,this.popup.setCallbackRefuse(()=>this.getCallbackRefuse()),this.popup.setCallbackAccept(()=>this.getCallbackAccept()),this.communicator=r,this.dispatcher=a,this.timers=[]}handle(t,e=!0){throw new Error(`The method 'handle' must be implemented ${t}`)}storeTrigger(t){const e=this.triggerStorage;e.setTrigger(t),e.exclude(t),this.dispatcher.emit("trigger.stored",t),this.dispatcher.emit("store.updated")}launch(t){this.sendLaunch(t,e=>{this.handle(e)})}sendLaunch(t,e){this.communicator.sendAction(t.id,t.secure,"launch",i=>{t.invitationMessage=i.invitation_message,typeof e=="function"&&e(t),this.dispatcher.emit("launch",t.id,t.name,t.category,t.startMode),this.dispatcher.emit("store.updated")},i=>{this.dispatcher.emit("trigger.launch-error",i),this.triggerStorage.setTrigger(null),this.triggerStorage.exclude(t),this.dispatcher.emit("store.updated")})}getCallbackRefuse(){const t=this.triggerStorage.getTrigger();if(!t)return!1;this.popup.destroy(),t.refuse(),this.communicator.sendAction(t.id,t.secure,"refuse",()=>{}),this.dispatcher.emit("refuse",t.id,t.name,t.category,t.startMode),this.dispatcher.emit("store.updated")}getCallbackAccept(){const t=this.triggerStorage.getTrigger();if(!t)return!1;if(this.popup.destroy(),t.accept(),this.communicator.sendAction(t.id,t.secure,"accept",()=>{}),this.dispatcher.emit("accept",t.id,t.name,t.category,t.startMode),this.dispatcher.emit("store.updated"),typeof window.calleoChat=="undefined"){if(this.config.apiSettings.enabled_old_popup){const e=[];t.id&&e.push(`live_trigger_id=${t.id}`),e.push(`additional_data[current_url]=${encodeURIComponent(window.location.href)}`),p.popupBottomRight(`${this.communicator.getUriLivechat()}?${this.customerStorage.getQueryParams()}&${e.join("&")}`,"chatwindow",400,570,{location:1,scrollbars:1})}}else window.calleoChat("startChat",{liveTriggerId:t.id,liveTriggerStartMode:t.startMode})}showPopup(t,e=!0){this.popup.show(t.invitationMessage,e);const i=this.calcRestInvitationReactionTime(t)*1e3;this.timers.push(window.setTimeout(()=>{this.hidePopup(),this.handleIgnore(t)},i))}handleIgnore(t){!t.isIgnore()&&!t.isAnswered()&&(t.ignore(),this.dispatcher.emit("ignore",t.id,t.name,t.category,t.startMode),this.dispatcher.emit("store.updated"))}hidePopup(){this.popup.destroy()}calcRestInvitationReactionTime(t){const i=(new Date().getTime()-t.launchedAt||0)/1e3,s=this.config.apiSettings.invitation_reaction_time-i;return Number(s)}clear(){this.timers.forEach(t=>{t&&window.clearTimeout(t)}),this.timers=[]}}class Et extends D{handle(t,e=!0){let i=t.attribs.delay*1e3;const s=new Date().getTime()-t.activatedAt;i-=s,!e&&i>0&&this.dispatcher.emit("trigger.activated-with-delay",t,i/1e3),t.isLaunched()?this.showPopup(t,e):this.timers.push(window.setTimeout(()=>{this.sendLaunch(t,()=>{t.launch(),this.showPopup(t,e)})},i))}launch(t){this.storeTrigger(t);const e=t.attribs.delay*1e3;this.dispatcher.emit("trigger.activated-with-delay",t,e/1e3),this.timers.push(window.setTimeout(()=>{this.handle(t)},e))}}class Mt extends D{handle(t,e=!0){t.isLaunched()?(this.showPopup(t,e),e&&this.storeTrigger(t)):this.launch(t)}launch(t){const e=t.attribs.delay*1e3;this.dispatcher.emit("trigger.launch-delayed",t,t.attribs.delay),this.timers.push(window.setTimeout(()=>{super.sendLaunch(t,i=>{i.launch(),this.handle(i)})},e))}}class Pt extends D{handle(t,e=!0){t.launch(),this.showPopup(t,e),e&&this.storeTrigger(t,e)}}class Nt extends D{handle(t,e=!0){t.activationType="delay",this.dispatcher.emit("trigger.activated-next-page",t)}launch(t){this.storeTrigger(t),this.handle(t,!1)}}const Rt="https://www.contact.nespresso.com/c/apps/calleo-triggers/assets/icon-chat.d3e0d39c.svg";class Ot{constructor(t){this.translator=t,this.msg="",this.callbackAccept=null,this.callbackRefuse=null,this.element="nespresso-live-trigger",this.collapseClassName="nlc-collapse",this.expandClassName="nlc-expand",this.hideClassName="is-hide",this.localStorageCollapse="nlc-collapse"}setCallbackAccept(t){this.callbackAccept=t}setCallbackRefuse(t){this.callbackRefuse=t}show(t=null,e=!0){this.getElement()&&this.msg===t||(t&&(this.msg=t),this.build(e))}build(t){t===!0&&localStorage.removeItem(this.localStorageCollapse);const e=this.translator.get("js_live_trigger.popup.button.refuse"),i=this.translator.get("js_live_trigger.popup.button.accept");this.removeElement(),document.body.classList.add("livetrigger-displayed");const s=localStorage.getItem(this.localStorageCollapse)==="true"?` ${this.localStorageCollapse}`:"",r=`<aside role="alert" aria-live="assertive" aria-atomic="true" aria-describedby="nlc-title" id="${this.element}" class="nlc-container${s}">
                        <header class="nlc-header">
                            <div class="nlc-wrapper">
                                <div class="nlc-icon-wrapper">
                                    <div class="nlc-icon">
                                        <a href="javascript:void(0)" class="nlc-action-expand">
                                            <img width="24px" height="24px" src=${Rt} alt="Icon" class="white-svg"/>
                                        </a>
                                    </div>
                                </div>
                                <div id="nlc-title" class="nlc-title" role="heading" aria-label="${p.htmlEscape(this.msg)}" aria-controls="nlc-actions">
                                    <span>${p.nl2br(p.htmlEscape(this.msg))}</span>
                                </div>
                                <div class="nlc-actions"><!-- Keep this node--></div>
                            </div>
                        </header>
                        <footer class="nlc-footer">
                            <div id="nlc-actions" class="nlc-actions">
                                <button class="nlc-bt nlc-bt-cancel" data-action="refuse" role="button">
                                    <span>${p.htmlEscape(e)}</span>
                                </button>
                                <button class="nlc-bt nlc-bt-main" data-action="accept" role="button" tabindex="0">
                                    <span>${p.htmlEscape(i)}</span>
                                </button>
                            </div>
                        </footer>
                    </aside>`,a=p.create(r);document.body.insertBefore(a,document.body.childNodes[0]),this.listeningEvent()}listeningEvent(){if(!this.getElement())return;const e=this.getBtnAccept();e&&e.addEventListener("click",this.runCallbackAccept.bind(this),!1);const i=this.getBtnRefuse();i&&i.addEventListener("click",this.runCallbackRefuse.bind(this,window.event),!1)}getBtnAccept(){return this.getElement().querySelector("button[data-action=accept]")}getBtnRefuse(){return this.getElement().querySelector("button[data-action=refuse]")}runCallbackAccept(){const t=this.getBtnAccept();t&&t.disable!==!0&&typeof this.callbackAccept=="function"&&(this.callbackAccept(),t.disable=!0)}runCallbackRefuse(){const t=this.getBtnRefuse();t&&t.disable!==!0&&typeof this.callbackRefuse=="function"&&(this.callbackRefuse(),t.disable=!0)}hide(t=null){const e=this.getElement();e&&p.addClass(e,this.hideClassName),typeof t=="function"&&setTimeout(()=>t(),200)}destroy(){this.hide(()=>{this.removeElement()})}getElement(){return document.getElementById(this.element)}removeElement(){document.body.classList.remove("livetrigger-displayed");const t=this.getElement();t&&t.parentNode.removeChild(t)}collapse(){const t=this.getElement();!t||(p.addClass(t,this.collapseClassName),p.removeClass(t,this.expandClassName),localStorage.setItem(this.localStorageCollapse,!0))}expand(){const t=this.getElement();!t||(p.addClass(t,this.expandClassName),p.removeClass(t,this.collapseClassName),localStorage.setItem(this.localStorageCollapse,!1))}}class kt{constructor(){this._translations={},this._lists={}}pushTranslations(t){this._translations=Object.assign({},this._translations,t)}pushList(t){this._lists=Object.assign({},this._lists,t)}get(t){return this._translations[t]?this._translations[t]:t}getList(t){return this._lists[t]?this._lists[t]:{}}getListValue(t,e,i=null){const s=this.getList(t);return s&&s[e]?s[e]:i}}class Dt{constructor(t=window,e,i,s){this._id="live-trigger-test-mode",this._key="live_trigger_test_mode",this._storageManager=e,this._isEnabled=this._retrieveTestModeState(t),this._dispatcher=i,this._datalayer=s,this._win=t,this.isEnabled&&(this._buildInfoBlock(t),this._initListeners())}_initListeners(){const t=this._dispatcher;t.on("trigger.loading",()=>{this._api("Loading triggers...")}),t.on("history.pushState",(e,i,s)=>{this._log(`Navigate to ${s}`)}),t.on("history.hashchange",e=>{this._log(`Navigate to anchor ${e}`)}),t.on("trigger.loading.error",e=>{this._error(`API Error: ${this._formatXhrError(e)}`)}),t.on("trigger.send-action",e=>{this._api(`Sending '${e}' statistics to server`)}),t.on("trigger.send-action.error",e=>{this._error(`API Error: ${this._formatXhrError(e)}`)}),t.on("cart.updated",()=>{this._log("Cart updated")}),t.on("trigger.is-showable",(e,i)=>{const r=(new Date().getTime()-e.launchedAt)/1e3,a=parseInt(i-r,10);this._success(`The trigger #${e.id} (${e.name}) has been previously <strong>launched</strong> and will be sticky for ${a} more seconds`)}),t.on("trigger.is-expired",e=>{this._log(`The trigger's expiration time (${e} minutes) has been reached. Now we can search for new triggers to display`)}),t.on("trigger.livechat-busy",()=>{this._warn("The livechat is currently busy (customer already in chat)")}),t.on("trigger.livechat-expand",()=>{this._warn("A livechat is expanded, ignore triggers.")}),t.on("trigger.livechat-launch",()=>{this._warn("A livechat is launch, ignore current active trigger.")}),t.on("trigger.livechat-expand.ignore",()=>{this._warn("A livechat expand, ignore current active trigger.")}),t.on("trigger.livechat-not-showable",(e,i)=>{const s=new Date().getTime(),r=parseInt(i-(s-e)/1e3,10);let a=`${r} seconds`;r>120&&(a=`~${parseInt(r/60,10)} minutes`),this._warn(`A livechat has been previously launch. The next triggers will be processed in ${a}`)}),t.on("trigger.is-not-showable",(e,i)=>{const s=new Date().getTime(),r=e.refusedAt||e.acceptedAt||e.launchedAt,a=(s-r)/1e3,o=parseInt(i-a,10);let c=`${o} seconds`;o>120&&(c=`~${parseInt(o/60,10)} minutes`),this._warn(`The trigger #${e.id} (${e.name}) has been previously fired. The next triggers will be processed in ${c}`)}),t.on("trigger.processing",e=>{const i=e.map(s=>s.id);this._log(`Processing ${e.length} triggers from API. (${i.join(", ")}) `)}),t.on("trigger.matched",e=>{this._success(`The trigger #${e.id} (name: ${e.name}, start mode: ${e.startMode}) matches all the criteria !`)}),t.on("trigger.match-none",()=>{this._log("No trigger matches the criteria")}),t.on("trigger.match-error",e=>{this._error(`An error occurred while matching the triggers : ${e.message}`)}),t.on("trigger.stored",e=>{this._log(`Storing the trigger #${e.id} (${e.name}) so it can be re-displayed even if the user changes the page. The trigger is also added to the exclusion list so it won't be shown again.`)}),t.on("trigger.is-excluded",e=>{this._log(`Ignoring trigger #${e.id} (${e.name}) because it has already been shown`)}),t.on("trigger.activated-with-delay",(e,i)=>{this._log(`The trigger #${e.id} (${e.name}) is activated and will be shown in ${parseInt(i,10)} seconds`)}),t.on("trigger.launch-delayed",(e,i)=>{this._log(`The trigger #${e.id} (${e.name}) will be <strong>launched</strong> in ${i} seconds`)}),t.on("trigger.activated-next-page",e=>{this._log(`The trigger #${e.id} (${e.name}) is activated and will be shown on the next page`)}),t.on("settings.not-enabled",()=>{this._warn("The current market's Livechat Proactive isn't enabled. All customer's behaviour is ignored")}),t.on("settings.chat_is_not_open",()=>{this._log("The current market's Livechat isn't open.")}),t.on("settings.absent-moderator-in-room",()=>{this._log("No operator in the room chat room agent only trigger not launched")}),t.on("settings.customer-percent",(e,i)=>{this._warn(`The customer has been excluded from the target due to the percent setting, percent get: ${e}% percent set: ${i}%`)}),t.on("reset.storage",()=>{this._warn("The storage has been cleared!")})}get isEnabled(){return this._isEnabled}_retrieveTestModeState(t){const e=t.localStorage;if(!e)return!1;const i=String(t.location.search);return i.indexOf(`${this._key}=`)!==-1&&(i.indexOf(`${this._key}=no`)!==-1?(e.setItem(this._key,"0"),e.setItem(`${this._key}_mini`,"0")):i.indexOf(`${this._key}=yes`)!==-1&&e.setItem(this._key,"1")),e.getItem(this._key)==="1"}_buildInfoBlock(t){const e=`<div id="${this._id}" class="${this._id}">
            <div class="${this._id}-minimal" title="Expand" id="${this._id}-minimal">LiveTrigger Test Mode &gt;</div>
            <span class="${this._id}-head">LIVE TRIGGER IN TEST MODE</span>
            <div id="${this._id}-log" class="log"></div>
            <div class="actions">
                <button id="${this._id}-reduce" class="${this._id}-action-btn" title="Reduce"> &lt; </button> &nbsp;
                <button id="${this._id}-datalayer" class="${this._id}-reset">Show Datalayer</button>
                <button id="${this._id}-reset" class="${this._id}-reset">Reset storage</button>
                <button id="${this._id}-deactivate" class="${this._id}-deactivate">End test mode</button>
            </div>
        </div>`,i=p.create(e);t.document.body.appendChild(i),t.document.getElementById(`${this._id}-deactivate`).addEventListener("click",()=>{t.localStorage.setItem(this._key,"0"),this._storageManager.cleanUpSession(),t.location.replace(t.location.pathname)},!1),t.document.getElementById(`${this._id}-reset`).addEventListener("click",()=>{this._storageManager.cleanUpSession(),this._dispatcher.emit("reset.storage"),t.location.reload()},!1),t.document.getElementById(`${this._id}-datalayer`).addEventListener("click",()=>{this._log(this._datalayer.prettyRenderHtml())},!1),t.document.getElementById(`${this._id}-reduce`).addEventListener("click",()=>{this._minimized(!0)},!1),t.document.getElementById(`${this._id}-minimal`).addEventListener("click",()=>{this._minimized(!1)},!1),this._minimized(parseInt(t.localStorage.getItem(`${this._key}_mini`),10))}_minimized(t=!1){const e=this._win.document.getElementById(`${this._id}`),i=this._win.localStorage;t?p.addClass(e,"minized"):p.removeClass(e,"minized"),i&&i.setItem(`${this._key}_mini`,t?"1":"0")}_log(t,e="info"){const i=document.getElementById(`${this._id}-log`),s=document.createElement("div");s.className=`item ${e}`,s.innerHTML=t,i.appendChild(s),i.scrollTop=i.scrollHeight}_success(t){this._log(t,"success")}_error(t){this._log(t,"error")}_warn(t){this._log(t,"warn")}_api(t){this._log(t,"api")}_formatXhrError(t){let e=`${t.status} ${t.statusText}`;try{const i=JSON.parse(t.response);e+=`: ${i.error_description}`}catch(i){}return e}}class Vt{constructor(t,e=window){this._win=e,this._translator=t,this._reset()}_reset(){this.pageId="",this.title="",this.firstName="",this.lastName="",this.email="",this.nessClubId="",this.isLoggedIn="",this.city="",this.zip="",this.customerSegment={},this.billingAddress=null,this.deliveryAddress=null,this.cart={nbItem:0,nbUniqueItem:0,totalAmount:0,items:[]}}init(t,e,i){this.market=t,this.language=e,this.channel=i}load(){try{this._reset(),this._retrieveStoreData(),this.map()}catch(t){console.error(t)}}map(){this._mapGeneric(),this._mapCustomer(),this._mapCart()}_getFromStorage(t,e=null){try{let i=this._win.sessionStorage.getItem(t);if(i||(i=this._win.localStorage.getItem(t)),i){const s=JSON.parse(i);return e?s&&typeof s[e]!="undefined"?s[e]:(console.warn(`datalayer cannot get ${e} from ${t}`),null):s}}catch(i){console.warn(`datalayer cannot read ${t}`)}return null}_retrieveStoreData(){try{this._padl=this._win.padl&&this._win.padl.events?this._win.padl.events:this._win.padl}catch(t){console.warn(`datalayer cannot read padl from window ${t}`)}this._padl2=this._getFromStorage(`padl-${this.channel}-${this.market}`),this._cart=this._getFromStorage(`cart-${this.market}-${this.channel}`,"cartLines"),this._cart||(this._cart=this._getFromStorage(`cart-${this.market}`)),this._customerInfo=this._getFromStorage(`customerInfo-${this.market}`),this._products=this._getFromStorage(`products-${this.market}-${this.language}-${this.channel}`),this._products||(this._products=this._getFromStorage(`products-${this.market}-${this.language}`)),this._categories=this._getFromStorage(`categories-${this.market}-${this.language}-${this.channel}`),this._categories||(this._categories=this._getFromStorage("categories"));try{const t=this._getFromStorage(`customerAddressesCache-${this.market}`,"value");if(t)for(let e=0;e<t.length;e++)t[e].defaultBilling&&(this.billingAddress=t[e]),t[e].defaultDelivery&&(this.deliveryAddress=t[e])}catch(t){console.warn(`datalayer cannot read customerAddressesCache ${t}`)}}_mapCustomer(){this._win.padl&&this._win.padl.user?this.isLoggedIn=this._win.padl.user.isLoggedIn:this.isLoggedIn=!1,this.isLoggedIn&&(this._win.padl&&this._win.padl.user&&this._win.padl.user.clubMember?this._mapFromPadl(this._win.padl):this._padl&&this._padl.user&&this._padl.user.clubMember?this._mapFromPadl(this._padl):this._padl2&&this._padl2.user&&this._padl2.user.clubMember&&this._mapFromPadl(this._padl2),this.billingAddress&&(!this.title&&this.billingAddress.civility&&(this.title=this._convertTitle(this.billingAddress.civility.label)),this.firstName||(this.firstName=this.billingAddress.firstName),this.lastName||(this.lastName=this.billingAddress.name),this.city=this.billingAddress.city||"",this.zip=this.billingAddress.zipCode||""),this._customerInfo&&(this.title||(this.title=this._convertTitle(this._customerInfo.civility)),this.firstName||(this.firstName=this._customerInfo.firstName),this.lastName||(this.lastName=this._customerInfo.lastName),this.email||(this.email=this._customerInfo.email)))}_mapFromPadl(t){if(t.user&&t.user.clubMember){const e=t.user.clubMember;if(this.title=this._convertTitle(e.clubMemberTitle),this.firstName=e.clubMemberFirstName||"",this.lastName=e.clubMemberLastName||"",this.email=e.clubMemberEmail||"",this.nessClubId=e.clubMemberID||"",this.customerSegment={},e.clubMemberTierID&&e.clubMemberLevel){const i=String(e.clubMemberTierID).toLowerCase().split(","),s=String(e.clubMemberLevel).toLowerCase().split(",");for(let r=0;r<i.length;r++)this.customerSegment[String(i[r]).trim()]=String(s[r]).trim()}}}_mapGeneric(){try{this._padl&&this._padl.navigation&&this._padl.navigation.pageView&&this._padl.navigation.pageView[this._padl.navigation.pageView.length-1]&&(this.pageId=this._padl.navigation.pageView[this._padl.navigation.pageView.length-1].page.pageInfo.breadcrumbUID)}catch(t){console.error(t)}try{this._padl&&this._padl.navigation&&this._padl.navigation.pageView&&this._padl.navigation.pageView[this._padl.navigation.pageView.length-1]&&(this.pageId=this._padl.navigation.pageView[this._padl.navigation.pageView.length-1].page.pageInfo.breadcrumbUID)}catch(t){console.error(t)}}_mapCart(){let t=0,e=0,i=0;const s=[];if(this._cart)for(let r=0;r<this._cart.length;r++){const a=this._cart[r];e++,t+=a.quantity,i+=a.unitPrice*a.quantity,s.push(this._extractCartItem(a))}this.cart.items=s,this.cart.nbItem=t,this.cart.nbUniqueItem=e,this.cart.totalAmount=i}_convertTitle(t){try{return this._translator.getListValue("titleMapping",String(t).trim().toLowerCase().replace(".",""))}catch(e){console.error(e)}return null}_extractCartItem(t){const e={productId:t.productId,quantity:t.quantity,unitPrice:t.unitPrice,names:[],categories:[],technologies:[]},i=this._products&&this._products[t.productId];if(i){if(e.names.push(String(i.internationalId).toLowerCase().trim()),e.names.push(String(i.internationalName).toLowerCase().trim()),e.names.push(String(i.name).toLowerCase().trim()),e.categories.push(String(i.rootCategory).toLowerCase().trim()),e.categories.push(String(i.category).toLowerCase().trim()),this._categories&&i.supercategories)for(let s=0;s<i.supercategories.length;s++){const r=this._categories[i.supercategories[s]];r&&e.categories.push(String(r.name).toLowerCase().trim())}if(e.categories=this._arrayUnique(e.categories),i.technologies)for(let s=0;s<i.technologies.length;s++){const r=String(i.technologies[s]).split("/").pop();r&&e.technologies.push(String(r).toLowerCase().trim())}}return e}_arrayUnique(t){const e={},i=[];for(let s=0;s<t.length;s++)e[t[s]]=!0;for(const s in e)Object.prototype.hasOwnProperty.call(e,s)&&i.push(s);return i}prettyRenderHtml(){let t="<pre>",e;t+=`Datalayer Info
`,t+=`==============
`,t+=` - Page ID : ${this.pageId}
`,t+=`=> Client
`,["title","firstName","lastName","email","nessClubId","city","zip"].forEach(i=>{t+=` - ${i.charAt(0).toLowerCase()+i.slice(1)} : ${this[i]}
`}),t+=` - Is Logged In : ${this.isLoggedIn?"true":"false"}
`;for(const i in this.customerSegment)Object.prototype.hasOwnProperty.call(this.customerSegment,i)&&i&&this.customerSegment[i]&&(t+=` - Segmentation ${i} : ${this.customerSegment[i]}
`);t+=`=> Cart
`,t+=` - Nb Products : ${this.cart.nbUniqueItem}
`,t+=` - Total Amount : ${this.cart.totalAmount}
`,t+=` -> Items : 
`;for(let i=0;i<this.cart.items.length;i++)e=this.cart.items[i],t+=`    -> Product Names  : ${e.names.join(", ")}
`,t+=`       - technologies : ${e.technologies.join(", ")}
`,t+=`       - categories   : ${e.categories.join(", ")}
`;return t+="</pre>",t}}var B={exports:{}},I=typeof Reflect=="object"?Reflect:null,H=I&&typeof I.apply=="function"?I.apply:function(t,e,i){return Function.prototype.apply.call(t,e,i)},O;I&&typeof I.ownKeys=="function"?O=I.ownKeys:Object.getOwnPropertySymbols?O=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:O=function(t){return Object.getOwnPropertyNames(t)};function jt(n){console&&console.warn&&console.warn(n)}var W=Number.isNaN||function(t){return t!==t};function h(){h.init.call(this)}B.exports=h;B.exports.once=zt;h.EventEmitter=h;h.prototype._events=void 0;h.prototype._eventsCount=0;h.prototype._maxListeners=void 0;var K=10;function V(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(h,"defaultMaxListeners",{enumerable:!0,get:function(){return K},set:function(n){if(typeof n!="number"||n<0||W(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");K=n}});h.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};h.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||W(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function Q(n){return n._maxListeners===void 0?h.defaultMaxListeners:n._maxListeners}h.prototype.getMaxListeners=function(){return Q(this)};h.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e.push(arguments[i]);var s=t==="error",r=this._events;if(r!==void 0)s=s&&r.error===void 0;else if(!s)return!1;if(s){var a;if(e.length>0&&(a=e[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var c=r[t];if(c===void 0)return!1;if(typeof c=="function")H(c,this,e);else for(var l=c.length,m=it(c,l),i=0;i<l;++i)H(m[i],this,e);return!0};function Z(n,t,e,i){var s,r,a;if(V(e),r=n._events,r===void 0?(r=n._events=Object.create(null),n._eventsCount=0):(r.newListener!==void 0&&(n.emit("newListener",t,e.listener?e.listener:e),r=n._events),a=r[t]),a===void 0)a=r[t]=e,++n._eventsCount;else if(typeof a=="function"?a=r[t]=i?[e,a]:[a,e]:i?a.unshift(e):a.push(e),s=Q(n),s>0&&a.length>s&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=n,o.type=t,o.count=a.length,jt(o)}return n}h.prototype.addListener=function(t,e){return Z(this,t,e,!1)};h.prototype.on=h.prototype.addListener;h.prototype.prependListener=function(t,e){return Z(this,t,e,!0)};function Ft(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Y(n,t,e){var i={fired:!1,wrapFn:void 0,target:n,type:t,listener:e},s=Ft.bind(i);return s.listener=e,i.wrapFn=s,s}h.prototype.once=function(t,e){return V(e),this.on(t,Y(this,t,e)),this};h.prototype.prependOnceListener=function(t,e){return V(e),this.prependListener(t,Y(this,t,e)),this};h.prototype.removeListener=function(t,e){var i,s,r,a,o;if(V(e),s=this._events,s===void 0)return this;if(i=s[t],i===void 0)return this;if(i===e||i.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete s[t],s.removeListener&&this.emit("removeListener",t,i.listener||e));else if(typeof i!="function"){for(r=-1,a=i.length-1;a>=0;a--)if(i[a]===e||i[a].listener===e){o=i[a].listener,r=a;break}if(r<0)return this;r===0?i.shift():Bt(i,r),i.length===1&&(s[t]=i[0]),s.removeListener!==void 0&&this.emit("removeListener",t,o||e)}return this};h.prototype.off=h.prototype.removeListener;h.prototype.removeAllListeners=function(t){var e,i,s;if(i=this._events,i===void 0)return this;if(i.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):i[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete i[t]),this;if(arguments.length===0){var r=Object.keys(i),a;for(s=0;s<r.length;++s)a=r[s],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=i[t],typeof e=="function")this.removeListener(t,e);else if(e!==void 0)for(s=e.length-1;s>=0;s--)this.removeListener(t,e[s]);return this};function tt(n,t,e){var i=n._events;if(i===void 0)return[];var s=i[t];return s===void 0?[]:typeof s=="function"?e?[s.listener||s]:[s]:e?qt(s):it(s,s.length)}h.prototype.listeners=function(t){return tt(this,t,!0)};h.prototype.rawListeners=function(t){return tt(this,t,!1)};h.listenerCount=function(n,t){return typeof n.listenerCount=="function"?n.listenerCount(t):et.call(n,t)};h.prototype.listenerCount=et;function et(n){var t=this._events;if(t!==void 0){var e=t[n];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}h.prototype.eventNames=function(){return this._eventsCount>0?O(this._events):[]};function it(n,t){for(var e=new Array(t),i=0;i<t;++i)e[i]=n[i];return e}function Bt(n,t){for(;t+1<n.length;t++)n[t]=n[t+1];n.pop()}function qt(n){for(var t=new Array(n.length),e=0;e<t.length;++e)t[e]=n[e].listener||n[e];return t}function zt(n,t){return new Promise(function(e,i){function s(a){n.removeListener(t,r),i(a)}function r(){typeof n.removeListener=="function"&&n.removeListener("error",s),e([].slice.call(arguments))}st(n,t,r,{once:!0}),t!=="error"&&Ht(n,s,{once:!0})})}function Ht(n,t,e){typeof n.on=="function"&&st(n,"error",t,e)}function st(n,t,e,i){if(typeof n.on=="function")i.once?n.once(t,e):n.on(t,e);else if(typeof n.addEventListener=="function")n.addEventListener(t,function s(r){i.once&&n.removeEventListener(t,s),e(r)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}let T={livechatController:"contact/index",url:{api:"https://www.contact.nespresso.com",livechat:"https://www.contact.nespresso.com/livechat"},apiSettings:{timezone:0,enabled:!0,is_chat_open:!0,enabled_old_popup:!1,moderator_in_room:1},market_id:0};const q=new kt,M=new Vt(q),b=new B.exports,d=new ot(T,M),_=new ct(M),w=new lt(M),x=new ht,rt=new at({customer:d,navigation:_,cart:w,trigger:x},"customer",T,b),U=new It(T,b),N=new Ot(q),Kt=new Dt(window,rt,b,M);U.setTestMode(Kt.isEnabled);const Xt={"navigation_history.all_page_id":new dt(_),"navigation_history.any_page_id":new gt(_),"navigation_history.all_url":new k(_),"navigation_history.any_url":new G(_),"navigation_history.regexp_url":new pt(_),"navigation_history.visited_pages":new mt(_),"current_page.any_page_id":new St(_),"current_page.any_url":new J(_),"current_page.regexp_url":new Ct(_),"cart.value":new bt(w),"cart.product":new yt(w),"cart.all_product_segmentation":new R(w,"categories","product_segmentation"),"cart.any_product_segmentation":new j(w,"categories","product_segmentation"),"cart.all_product_technology":new R(w,"technologies","product_technology"),"cart.any_product_technology":new j(w,"technologies","product_technology"),"cart.all_product_name":new R(w,"names","product_name"),"cart.any_product_name":new j(w,"names","product_name"),"market.channel":new Tt(d),"market.language":new Lt(d),"customer.city":new ft(d),"customer.zip":new _t(d),"customer.time_logged":new vt(d),"customer.logged":new wt(d),"customer.segment_1":new A(d,"1"),"customer.segment_2":new A(d,"2"),"customer.segment_3":new A(d,"3"),"customer.segment_4":new A(d,"4"),"customer.segment_5":new A(d,"5"),"customer.segment_6":new A(d,"6"),"customer.segment_club":new A(d,"club"),"time.on_current_page":new At(_),"time.on_site":new $t(_),"display.breakpoint":new xt},Gt=new ut(Xt),Jt=new Ut(Gt,b,x),Wt={delay:new Et(T,x,d,N,U,b),time_on_page:new Mt(T,x,d,N,U,b),immediately:new Pt(T,x,d,N,U,b),next_page:new Nt(T,x,d,N,U,b)},Qt=new nt(T,U,rt,Jt,Wt,q,b,M);Qt.start();
//# 
})();